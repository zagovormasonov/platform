import { Server } from 'socket.io'
import http from 'http'
import cors from 'cors'

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ HTTP ÑÐµÑ€Ð²ÐµÑ€
const server = http.createServer();

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Socket.IO ÑÐµÑ€Ð²ÐµÑ€ Ñ CORS Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸
const io = new Server(server, {
  cors: {
    origin: [
      "http://localhost:5173", 
      "http://localhost:3000", 
      "https://platform-ruby-kappa.vercel.app",
      "https://vercel.app",
      "https://*.vercel.app"
    ],
    methods: ["GET", "POST"],
    credentials: true
  },
  transports: ['websocket', 'polling']
});

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
const activeUsers = new Map();
// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚ Ñ‡Ð°Ñ‚Ð¾Ð²
const chatRooms = new Map();

// Middleware Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
io.use((socket, next) => {
  const userId = socket.handshake.auth.userId;
  if (!userId) {
    return next(new Error('User ID required'));
  }
  socket.userId = userId;
  next();
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
io.on('connection', (socket) => {
  const userId = socket.userId;
  console.log(`ðŸ‘¤ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userId} Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð»ÑÑ`);
  
  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ
  activeUsers.set(userId, {
    socketId: socket.id,
    connectedAt: new Date(),
    currentChat: null
  });

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¾Ð± ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸
  socket.emit('connected', {
    userId: userId,
    timestamp: new Date().toISOString()
  });

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð²ÑÐµÑ… Ð¾ Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ð½Ð»Ð°Ð¹Ð½
  socket.broadcast.emit('user_online', {
    userId: userId,
    timestamp: new Date().toISOString()
  });

  // ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ðº Ñ‡Ð°Ñ‚Ñƒ
  socket.on('join_chat', (data) => {
    const { chatId } = data;
    console.log(`ðŸ“± ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userId} Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÑ‚ÑÑ Ðº Ñ‡Ð°Ñ‚Ñƒ ${chatId}`);
    
    // ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ÑÑ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ Ñ‡Ð°Ñ‚Ð°
    socket.join(`chat_${chatId}`);
    
    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ Ñ‡Ð°Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const userInfo = activeUsers.get(userId);
    if (userInfo) {
      userInfo.currentChat = chatId;
    }
    
    // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
    if (!chatRooms.has(chatId)) {
      chatRooms.set(chatId, {
        id: chatId,
        participants: new Set(),
        createdAt: new Date()
      });
    }
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ
    chatRooms.get(chatId).participants.add(userId);
    
    // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ñ‡Ð°Ñ‚Ð° Ð¾ Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¸
    socket.to(`chat_${chatId}`).emit('user_joined_chat', {
      userId: userId,
      chatId: chatId,
      timestamp: new Date().toISOString()
    });
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ
    socket.emit('joined_chat', {
      chatId: chatId,
      participants: Array.from(chatRooms.get(chatId).participants),
      timestamp: new Date().toISOString()
    });
  });

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
  socket.on('send_message', (data) => {
    const { chatId, content, messageType = 'text' } = data;
    console.log(`ðŸ’¬ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userId} Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ñ‡Ð°Ñ‚ ${chatId}`);
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð² ÑÑ‚Ð¾Ð¼ Ñ‡Ð°Ñ‚Ðµ
    if (!socket.rooms.has(`chat_${chatId}`)) {
      socket.emit('error', {
        message: 'Ð’Ñ‹ Ð½Ðµ ÑÐ¾ÑÑ‚Ð¾Ð¸Ñ‚Ðµ Ð² ÑÑ‚Ð¾Ð¼ Ñ‡Ð°Ñ‚Ðµ',
        code: 'NOT_IN_CHAT'
      });
      return;
    }
    
    const message = {
      id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      chatId: chatId,
      senderId: userId,
      content: content,
      messageType: messageType,
      timestamp: new Date().toISOString(),
      isRead: false
    };
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð²ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°Ð¼ Ñ‡Ð°Ñ‚Ð°
    io.to(`chat_${chatId}`).emit('new_message', message);
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŽ
    socket.emit('message_sent', {
      messageId: message.id,
      timestamp: message.timestamp
    });
    
    console.log(`âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ${message.id} Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð² Ñ‡Ð°Ñ‚ ${chatId}`);
  });

  // ÐžÑ‚Ð¼ÐµÑ‚ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ…
  socket.on('mark_messages_read', (data) => {
    const { chatId, messageIds } = data;
    console.log(`ðŸ‘ï¸ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userId} Ð¾Ñ‚Ð¼ÐµÑ‡Ð°ÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ‡Ð°Ñ‚Ðµ ${chatId}`);
    
    // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ñ‡Ð°Ñ‚Ð°
    socket.to(`chat_${chatId}`).emit('messages_read', {
      chatId: chatId,
      userId: userId,
      messageIds: messageIds,
      timestamp: new Date().toISOString()
    });
  });

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
  socket.on('get_active_users', () => {
    const users = Array.from(activeUsers.keys());
    socket.emit('active_users', {
      users: users,
      count: users.length,
      timestamp: new Date().toISOString()
    });
  });

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‡Ð°Ñ‚Ðµ
  socket.on('get_chat_info', (data) => {
    const { chatId } = data;
    const chat = chatRooms.get(chatId);
    
    if (chat) {
      socket.emit('chat_info', {
        chatId: chatId,
        participants: Array.from(chat.participants),
        createdAt: chat.createdAt,
        isActive: chat.participants.size > 0
      });
    } else {
      socket.emit('error', {
        message: 'Ð§Ð°Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½',
        code: 'CHAT_NOT_FOUND'
      });
    }
  });

  // ÐŸÐ¸Ð½Ð³ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
  socket.on('ping', () => {
    socket.emit('pong', {
      timestamp: new Date().toISOString()
    });
  });

  // ÐŸÐ¾ÐºÐ¸Ð´Ð°Ð½Ð¸Ðµ Ñ‡Ð°Ñ‚Ð°
  socket.on('leave_chat', (data) => {
    const { chatId } = data;
    console.log(`ðŸšª ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userId} Ð¿Ð¾ÐºÐ¸Ð´Ð°ÐµÑ‚ Ñ‡Ð°Ñ‚ ${chatId}`);
    
    socket.leave(`chat_${chatId}`);
    
    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹
    const chat = chatRooms.get(chatId);
    if (chat) {
      chat.participants.delete(userId);
      
      // Ð•ÑÐ»Ð¸ Ð² Ñ‡Ð°Ñ‚Ðµ Ð½Ð¸ÐºÐ¾Ð³Ð¾ Ð½Ðµ Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ
      if (chat.participants.size === 0) {
        chatRooms.delete(chatId);
        console.log(`ðŸ—‘ï¸ ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° Ñ‡Ð°Ñ‚Ð° ${chatId} ÑƒÐ´Ð°Ð»ÐµÐ½Ð° (Ð½ÐµÑ‚ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²)`);
      }
    }
    
    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ Ñ‡Ð°Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const userInfo = activeUsers.get(userId);
    if (userInfo) {
      userInfo.currentChat = null;
    }
    
    // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ñ‡Ð°Ñ‚Ð° Ð¾ Ð²Ñ‹Ñ…Ð¾Ð´Ðµ
    socket.to(`chat_${chatId}`).emit('user_left_chat', {
      userId: userId,
      chatId: chatId,
      timestamp: new Date().toISOString()
    });
    
    socket.emit('left_chat', {
      chatId: chatId,
      timestamp: new Date().toISOString()
    });
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
  socket.on('disconnect', (reason) => {
    console.log(`ðŸ‘‹ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userId} Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ð»ÑÑ. ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: ${reason}`);
    
    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· Ð²ÑÐµÑ… Ñ‡Ð°Ñ‚Ð¾Ð²
    chatRooms.forEach((chat, chatId) => {
      if (chat.participants.has(userId)) {
        chat.participants.delete(userId);
        
        // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ñ‡Ð°Ñ‚Ð° Ð¾Ð± Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸
        socket.to(`chat_${chatId}`).emit('user_disconnected', {
          userId: userId,
          chatId: chatId,
          timestamp: new Date().toISOString()
        });
        
        // Ð•ÑÐ»Ð¸ Ð² Ñ‡Ð°Ñ‚Ðµ Ð½Ð¸ÐºÐ¾Ð³Ð¾ Ð½Ðµ Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ
        if (chat.participants.size === 0) {
          chatRooms.delete(chatId);
          console.log(`ðŸ—‘ï¸ ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° Ñ‡Ð°Ñ‚Ð° ${chatId} ÑƒÐ´Ð°Ð»ÐµÐ½Ð° (Ð½ÐµÑ‚ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²)`);
        }
      }
    });
    
    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ…
    activeUsers.delete(userId);
    
    // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð²ÑÐµÑ… Ð¾ Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ñ„Ð»Ð°Ð¹Ð½
    socket.broadcast.emit('user_offline', {
      userId: userId,
      timestamp: new Date().toISOString()
    });
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
  socket.on('error', (error) => {
    console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Socket.IO Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${userId}:`, error);
  });
});

// ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð½Ð°Ñ‚
setInterval(() => {
  const now = new Date();
  chatRooms.forEach((chat, chatId) => {
    if (chat.participants.size === 0) {
      chatRooms.delete(chatId);
      console.log(`ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°: ÑƒÐ´Ð°Ð»ÐµÐ½Ð° Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ð° ${chatId}`);
    }
  });
}, 300000); // ÐšÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚

// Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°
setInterval(() => {
  console.log(`ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°: ${activeUsers.size} Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, ${chatRooms.size} Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð¾Ð²`);
}, 60000); // ÐšÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 3001;
server.listen(PORT, () => {
  console.log(`ðŸš€ Socket.IO ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ðŸŒ CORS Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð´Ð»Ñ: https://platform-ruby-kappa.vercel.app`);
  console.log(`ðŸ”— URL Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ: ${process.env.NODE_ENV === 'production' ? 'https://platform-ruby-kappa.vercel.app' : 'http://localhost:3001'}`);
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGTERM, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  server.close(() => {
    console.log('âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°ÐºÑ€Ñ‹Ñ‚');
    process.exit(0);
  });
});

process.on('SIGINT', () => {
  console.log('ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGINT, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  server.close(() => {
    console.log('âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°ÐºÑ€Ñ‹Ñ‚');
    process.exit(0);
  });
});

export { io, server }
