import { Server } from 'socket.io';
import http from 'http';
import cors from 'cors';
import dotenv from 'dotenv';
import { query } from './config/database.js';

// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
dotenv.config();

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ HTTP ÑÐµÑ€Ð²ÐµÑ€
const server = http.createServer();

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Socket.IO ÑÐµÑ€Ð²ÐµÑ€ Ñ CORS Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸
const io = new Server(server, {
  cors: {
    origin: process.env.CORS_ORIGIN || "http://localhost:3000",
    methods: ["GET", "POST"],
    credentials: true
  },
  transports: ['websocket', 'polling']
});

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
const activeUsers = new Map();
// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚ Ñ‡Ð°Ñ‚Ð¾Ð²
const chatRooms = new Map();

// Middleware Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
io.use(async (socket, next) => {
  try {
    const userId = socket.handshake.auth.userId;
    if (!userId) {
      return next(new Error('User ID required'));
    }

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    const result = await query(
      'SELECT id, full_name FROM profiles WHERE id = $1',
      [userId]
    );

    if (result.rows.length === 0) {
      return next(new Error('User not found'));
    }

    socket.userId = userId;
    socket.userName = result.rows[0].full_name;
    next();
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Socket.IO:', error);
    next(new Error('Authentication failed'));
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
io.on('connection', (socket) => {
  const userId = socket.userId;
  const userName = socket.userName;
  
  console.log(`ðŸ‘¤ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userName} (${userId}) Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð»ÑÑ`);
  
  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ
  activeUsers.set(userId, {
    socketId: socket.id,
    userName: userName,
    connectedAt: new Date(),
    currentChat: null
  });

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¾Ð± ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸
  socket.emit('connected', {
    userId: userId,
    userName: userName,
    timestamp: new Date().toISOString()
  });

  // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð²ÑÐµÑ… Ð¾ Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ð½Ð»Ð°Ð¹Ð½
  socket.broadcast.emit('user_online', {
    userId: userId,
    userName: userName,
    timestamp: new Date().toISOString()
  });

  // ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ðº Ñ‡Ð°Ñ‚Ñƒ
  socket.on('join_chat', async (data) => {
    try {
      const { chatId } = data;
      console.log(`ðŸ“± ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userName} Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÑ‚ÑÑ Ðº Ñ‡Ð°Ñ‚Ñƒ ${chatId}`);
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð¼ Ñ‡Ð°Ñ‚Ð°
      const participantResult = await query(
        'SELECT id FROM chat_participants WHERE chat_id = $1 AND user_id = $2',
        [chatId, userId]
      );

      if (participantResult.rows.length === 0) {
        socket.emit('error', {
          message: 'Ð’Ñ‹ Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÐµÑÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð¼ ÑÑ‚Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°',
          code: 'NOT_PARTICIPANT'
        });
        return;
      }
      
      // ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ÑÑ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ Ñ‡Ð°Ñ‚Ð°
      socket.join(`chat_${chatId}`);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ Ñ‡Ð°Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      const userInfo = activeUsers.get(userId);
      if (userInfo) {
        userInfo.currentChat = chatId;
      }
      
      // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
      if (!chatRooms.has(chatId)) {
        chatRooms.set(chatId, {
          id: chatId,
          participants: new Set(),
          createdAt: new Date()
        });
      }
      
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ
      chatRooms.get(chatId).participants.add(userId);
      
      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
      const messagesResult = await query(
        `SELECT m.id, m.content, m.message_type, m.created_at, m.reply_to,
                p.id as sender_id, p.full_name as sender_name, p.avatar_url as sender_avatar
         FROM messages m
         JOIN profiles p ON m.sender_id = p.id
         WHERE m.chat_id = $1
         ORDER BY m.created_at ASC
         LIMIT 50`,
        [chatId]
      );
      
      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
      socket.emit('chat_history', {
        chatId: chatId,
        messages: messagesResult.rows
      });
      
      // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ñ‡Ð°Ñ‚Ð° Ð¾ Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¸
      socket.to(`chat_${chatId}`).emit('user_joined_chat', {
        userId: userId,
        userName: userName,
        chatId: chatId,
        timestamp: new Date().toISOString()
      });
      
      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ
      socket.emit('joined_chat', {
        chatId: chatId,
        participants: Array.from(chatRooms.get(chatId).participants),
        timestamp: new Date().toISOString()
      });
      
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ðº Ñ‡Ð°Ñ‚Ñƒ:', error);
      socket.emit('error', {
        message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ðº Ñ‡Ð°Ñ‚Ñƒ',
        code: 'JOIN_ERROR'
      });
    }
  });

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
  socket.on('send_message', async (data) => {
    try {
      const { chatId, content, messageType = 'text', replyTo } = data;
      console.log(`ðŸ’¬ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userName} Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ñ‡Ð°Ñ‚ ${chatId}`);
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð² ÑÑ‚Ð¾Ð¼ Ñ‡Ð°Ñ‚Ðµ
      if (!socket.rooms.has(`chat_${chatId}`)) {
        socket.emit('error', {
          message: 'Ð’Ñ‹ Ð½Ðµ ÑÐ¾ÑÑ‚Ð¾Ð¸Ñ‚Ðµ Ð² ÑÑ‚Ð¾Ð¼ Ñ‡Ð°Ñ‚Ðµ',
          code: 'NOT_IN_CHAT'
        });
        return;
      }
      
      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
      const messageResult = await query(
        `INSERT INTO messages (id, chat_id, sender_id, content, message_type, reply_to, created_at)
         VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, NOW())
         RETURNING id, created_at`,
        [chatId, userId, content, messageType, replyTo || null]
      );
      
      const messageId = messageResult.rows[0].id;
      const createdAt = messageResult.rows[0].created_at;
      
      const message = {
        id: messageId,
        chatId: chatId,
        senderId: userId,
        senderName: userName,
        content: content,
        messageType: messageType,
        replyTo: replyTo || null,
        timestamp: createdAt,
        isRead: false
      };
      
      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð²ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°Ð¼ Ñ‡Ð°Ñ‚Ð°
      io.to(`chat_${chatId}`).emit('new_message', message);
      
      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŽ
      socket.emit('message_sent', {
        messageId: messageId,
        timestamp: createdAt
      });
      
      console.log(`âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ${messageId} Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð² Ñ‡Ð°Ñ‚ ${chatId}`);
      
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', error);
      socket.emit('error', {
        message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ',
        code: 'SEND_ERROR'
      });
    }
  });

  // ÐžÑ‚Ð¼ÐµÑ‚ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ…
  socket.on('mark_messages_read', async (data) => {
    try {
      const { chatId, messageIds } = data;
      console.log(`ðŸ‘ï¸ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userName} Ð¾Ñ‚Ð¼ÐµÑ‡Ð°ÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ‡Ð°Ñ‚Ðµ ${chatId}`);
      
      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ¸ Ð¾ Ð¿Ñ€Ð¾Ñ‡Ñ‚ÐµÐ½Ð¸Ð¸ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
      if (messageIds && messageIds.length > 0) {
        for (const messageId of messageIds) {
          await query(
            `INSERT INTO message_reads (message_id, user_id, read_at)
             VALUES ($1, $2, NOW())
             ON CONFLICT (message_id, user_id) DO NOTHING`,
            [messageId, userId]
          );
        }
      }
      
      // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ñ‡Ð°Ñ‚Ð°
      socket.to(`chat_${chatId}`).emit('messages_read', {
        chatId: chatId,
        userId: userId,
        userName: userName,
        messageIds: messageIds,
        timestamp: new Date().toISOString()
      });
      
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ…:', error);
    }
  });

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
  socket.on('get_active_users', () => {
    const users = Array.from(activeUsers.values()).map(user => ({
      userId: user.socketId,
      userName: user.userName,
      connectedAt: user.connectedAt
    }));
    
    socket.emit('active_users', {
      users: users,
      count: users.length,
      timestamp: new Date().toISOString()
    });
  });

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‡Ð°Ñ‚Ðµ
  socket.on('get_chat_info', async (data) => {
    try {
      const { chatId } = data;
      
      const chatResult = await query(
        `SELECT c.id, c.name, c.type, c.created_at,
                COUNT(cp.user_id) as participant_count
         FROM chats c
         LEFT JOIN chat_participants cp ON c.id = cp.chat_id
         WHERE c.id = $1
         GROUP BY c.id, c.name, c.type, c.created_at`,
        [chatId]
      );
      
      if (chatResult.rows.length > 0) {
        const chat = chatResult.rows[0];
        const inMemoryChat = chatRooms.get(chatId);
        
        socket.emit('chat_info', {
          chatId: chatId,
          name: chat.name,
          type: chat.type,
          participantCount: parseInt(chat.participant_count),
          activeParticipants: inMemoryChat ? inMemoryChat.participants.size : 0,
          createdAt: chat.created_at,
          isActive: inMemoryChat ? inMemoryChat.participants.size > 0 : false
        });
      } else {
        socket.emit('error', {
          message: 'Ð§Ð°Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½',
          code: 'CHAT_NOT_FOUND'
        });
      }
      
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‡Ð°Ñ‚Ðµ:', error);
      socket.emit('error', {
        message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ñ‡Ð°Ñ‚Ðµ',
        code: 'CHAT_INFO_ERROR'
      });
    }
  });

  // ÐŸÐ¸Ð½Ð³ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
  socket.on('ping', () => {
    socket.emit('pong', {
      timestamp: new Date().toISOString()
    });
  });

  // ÐŸÐ¾ÐºÐ¸Ð´Ð°Ð½Ð¸Ðµ Ñ‡Ð°Ñ‚Ð°
  socket.on('leave_chat', (data) => {
    const { chatId } = data;
    console.log(`ðŸšª ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userName} Ð¿Ð¾ÐºÐ¸Ð´Ð°ÐµÑ‚ Ñ‡Ð°Ñ‚ ${chatId}`);
    
    socket.leave(`chat_${chatId}`);
    
    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹
    const chat = chatRooms.get(chatId);
    if (chat) {
      chat.participants.delete(userId);
      
      // Ð•ÑÐ»Ð¸ Ð² Ñ‡Ð°Ñ‚Ðµ Ð½Ð¸ÐºÐ¾Ð³Ð¾ Ð½Ðµ Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ
      if (chat.participants.size === 0) {
        chatRooms.delete(chatId);
        console.log(`ðŸ—‘ï¸ ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° Ñ‡Ð°Ñ‚Ð° ${chatId} ÑƒÐ´Ð°Ð»ÐµÐ½Ð° (Ð½ÐµÑ‚ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²)`);
      }
    }
    
    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ Ñ‡Ð°Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const userInfo = activeUsers.get(userId);
    if (userInfo) {
      userInfo.currentChat = null;
    }
    
    // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ñ‡Ð°Ñ‚Ð° Ð¾ Ð²Ñ‹Ñ…Ð¾Ð´Ðµ
    socket.to(`chat_${chatId}`).emit('user_left_chat', {
      userId: userId,
      userName: userName,
      chatId: chatId,
      timestamp: new Date().toISOString()
    });
    
    socket.emit('left_chat', {
      chatId: chatId,
      timestamp: new Date().toISOString()
    });
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
  socket.on('disconnect', (reason) => {
    console.log(`ðŸ‘‹ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userName} (${userId}) Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ð»ÑÑ. ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: ${reason}`);
    
    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· Ð²ÑÐµÑ… Ñ‡Ð°Ñ‚Ð¾Ð²
    chatRooms.forEach((chat, chatId) => {
      if (chat.participants.has(userId)) {
        chat.participants.delete(userId);
        
        // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ñ‡Ð°Ñ‚Ð° Ð¾Ð± Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸
        socket.to(`chat_${chatId}`).emit('user_disconnected', {
          userId: userId,
          userName: userName,
          chatId: chatId,
          timestamp: new Date().toISOString()
        });
        
        // Ð•ÑÐ»Ð¸ Ð² Ñ‡Ð°Ñ‚Ðµ Ð½Ð¸ÐºÐ¾Ð³Ð¾ Ð½Ðµ Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ
        if (chat.participants.size === 0) {
          chatRooms.delete(chatId);
          console.log(`ðŸ—‘ï¸ ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° Ñ‡Ð°Ñ‚Ð° ${chatId} ÑƒÐ´Ð°Ð»ÐµÐ½Ð° (Ð½ÐµÑ‚ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²)`);
        }
      }
    });
    
    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ…
    activeUsers.delete(userId);
    
    // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð²ÑÐµÑ… Ð¾ Ñ‚Ð¾Ð¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ñ„Ð»Ð°Ð¹Ð½
    socket.broadcast.emit('user_offline', {
      userId: userId,
      userName: userName,
      timestamp: new Date().toISOString()
    });
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
  socket.on('error', (error) => {
    console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Socket.IO Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${userName} (${userId}):`, error);
  });
});

// ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð½Ð°Ñ‚
setInterval(() => {
  const now = new Date();
  chatRooms.forEach((chat, chatId) => {
    if (chat.participants.size === 0) {
      chatRooms.delete(chatId);
      console.log(`ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°: ÑƒÐ´Ð°Ð»ÐµÐ½Ð° Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ð° ${chatId}`);
    }
  });
}, 300000); // ÐšÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚

// Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°
setInterval(() => {
  console.log(`ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°: ${activeUsers.size} Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, ${chatRooms.size} Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð¾Ð²`);
}, 60000); // ÐšÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 3002;
server.listen(PORT, () => {
  console.log(`ðŸš€ Socket.IO ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ðŸŒ CORS Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð´Ð»Ñ: ${process.env.CORS_ORIGIN || 'http://localhost:3000'}`);
  console.log(`ðŸ”— URL Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ: ${process.env.NODE_ENV === 'production' ? process.env.CORS_ORIGIN : 'http://localhost:3002'}`);
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGTERM, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  server.close(() => {
    console.log('âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°ÐºÑ€Ñ‹Ñ‚');
    process.exit(0);
  });
});

process.on('SIGINT', () => {
  console.log('ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGINT, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  server.close(() => {
    console.log('âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°ÐºÑ€Ñ‹Ñ‚');
    process.exit(0);
  });
});

export { io, server };
