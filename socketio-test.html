<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Chat Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .message.own {
            background-color: #e3f2fd;
        }
        .message.other {
            background-color: #f5f5f5;
        }
        input, button {
            padding: 8px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üîå Socket.IO Chat Test</h1>
    
    <div id="status" class="status disconnected">
        ‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
    </div>
    
    <div>
        <input type="text" id="userId" placeholder="–í–∞—à ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" value="test-user-1">
        <button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="disconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>
    
    <div>
        <input type="text" id="chatId" placeholder="ID —á–∞—Ç–∞" value="test-chat-1">
        <button onclick="joinChat()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É</button>
        <button onclick="leaveChat()">–ü–æ–∫–∏–Ω—É—Ç—å —á–∞—Ç</button>
    </div>
    
    <div class="messages" id="messages"></div>
    
    <div>
        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    
    <div>
        <button onclick="ping()">üèì Ping</button>
        <button onclick="getActiveUsers()">üë• –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        let currentUserId = null;
        let currentChatId = null;

        function connect() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            currentUserId = userId;
            
            socket = io('https://platform-ruby-kappa.vercel.app', {
                auth: {
                    userId: userId
                }
            });

            socket.on('connect', () => {
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω', 'connected');
                addMessage('system', `–ü–æ–¥–∫–ª—é—á–µ–Ω –∫–∞–∫ ${userId}`);
            });

            socket.on('disconnect', (reason) => {
                updateStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω: ' + reason, 'disconnected');
                addMessage('system', `–û—Ç–∫–ª—é—á–µ–Ω: ${reason}`);
            });

            socket.on('connected', (data) => {
                addMessage('system', `–°–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${JSON.stringify(data)}`);
            });

            socket.on('new_message', (message) => {
                addMessage('other', `${message.senderId}: ${message.content}`);
            });

            socket.on('message_sent', (data) => {
                addMessage('system', `–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.messageId}`);
            });

            socket.on('user_joined_chat', (data) => {
                addMessage('system', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.userId} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É ${data.chatId}`);
            });

            socket.on('user_left_chat', (data) => {
                addMessage('system', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.userId} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç ${data.chatId}`);
            });

            socket.on('active_users', (data) => {
                addMessage('system', `–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${data.users.join(', ')} (${data.count})`);
            });

            socket.on('pong', (data) => {
                addMessage('system', `üèì Pong –ø–æ–ª—É—á–µ–Ω: ${data.timestamp}`);
            });

            socket.on('error', (error) => {
                addMessage('system', `‚ùå –û—à–∏–±–∫–∞: ${error.message || error}`);
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                currentUserId = null;
                currentChatId = null;
            }
        }

        function joinChat() {
            const chatId = document.getElementById('chatId').value;
            if (!socket || !chatId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∏ –≤–≤–µ–¥–∏—Ç–µ ID —á–∞—Ç–∞');
                return;
            }

            currentChatId = chatId;
            socket.emit('join_chat', { chatId });
            addMessage('system', `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ —á–∞—Ç—É ${chatId}`);
        }

        function leaveChat() {
            if (!socket || !currentChatId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —á–∞—Ç—É');
                return;
            }

            socket.emit('leave_chat', { chatId: currentChatId });
            addMessage('system', `–ü–æ–∫–∏–¥–∞–µ–º —á–∞—Ç ${currentChatId}`);
            currentChatId = null;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!socket || !currentChatId || !content) {
                alert('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —á–∞—Ç—É –∏ –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }

            socket.emit('send_message', {
                chatId: currentChatId,
                content: content
            });

            addMessage('own', `–í—ã: ${content}`);
            messageInput.value = '';
        }

        function ping() {
            if (!socket) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å');
                return;
            }

            socket.emit('ping');
            addMessage('system', 'üèì Ping –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        }

        function getActiveUsers() {
            if (!socket) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å');
                return;
            }

            socket.emit('get_active_users');
            addMessage('system', '–ó–∞–ø—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function updateStatus(text, className) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = `status ${className}`;
        }

        function addMessage(type, text) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            addMessage('system', '–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"');
        };
    </script>
</body>
</html>
